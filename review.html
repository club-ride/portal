<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan Review ‚Äî Club Ride</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
<style>
  :root {
    --cream: #F7F4EF; --ink: #1A1A18; --ink-light: #5A5A56;
    --accent: #1F417F; --accent-light: #EBF0F8; --border: #E0DAD0;
    --white: #FFFFFF; --success: #8DAA43; --success-light: #F0F5E8;
    --warn: #C8860A; --warn-light: #FDF4E3; --danger: #C0392B; --danger-light: #FDECEA;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--ink); min-height: 100vh; }

  /* Header */
  .header { background: var(--ink); color: var(--white); padding: 14px 48px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .header-logo { height: 38px; width: auto; display: block; }
  .header-divider { width: 1px; height: 24px; background: rgba(255,255,255,0.2); }
  .header-badge { font-size: 11px; font-weight: 600; letter-spacing: 0.8px; text-transform: uppercase; color: rgba(255,255,255,0.6); padding: 4px 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .docx-btn { display: flex; align-items: center; gap: 7px; padding: 8px 16px; border-radius: 6px; background: rgba(255,255,255,0.1); color: var(--white); border: 1px solid rgba(255,255,255,0.25); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; display: none; }
  .docx-btn:hover { background: rgba(255,255,255,0.2); }
  .docx-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .status-badge { font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; }
  .status-pending { background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.7); }
  .status-approved { background: var(--success); color: white; }
  .status-revisions { background: var(--warn); color: white; }
  .status-denied { background: var(--danger); color: white; }

  /* Loading / Error */
  .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; gap: 16px; color: var(--ink-light); }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error-state { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; gap: 12px; text-align: center; padding: 40px; }
  .error-icon { font-size: 48px; }
  .error-title { font-size: 22px; font-weight: 700; }
  .error-sub { font-size: 14px; color: var(--ink-light); max-width: 400px; line-height: 1.6; }

  /* Layout */
  .layout { display: flex; min-height: calc(100vh - 67px); }
  .sidebar { width: 220px; flex-shrink: 0; background: var(--white); border-right: 1px solid var(--border); padding: 28px 0; position: sticky; top: 67px; height: calc(100vh - 67px); overflow-y: auto; }
  .sidebar-label { font-size: 10px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--ink-light); padding: 0 20px 12px; }
  .toc-item { display: flex; align-items: center; gap: 8px; padding: 8px 20px; font-size: 12px; color: var(--ink-light); cursor: pointer; transition: all 0.12s; border-left: 3px solid transparent; text-decoration: none; }
  .toc-item:hover { background: var(--cream); color: var(--ink); }
  .toc-item.active { color: var(--accent); border-left-color: var(--accent); background: var(--accent-light); font-weight: 500; }
  .main { flex: 1; padding: 40px 48px; max-width: 900px; }

  /* Plan header */
  .plan-header { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 32px 36px; margin-bottom: 24px; }
  .plan-eyebrow { font-size: 11px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--accent); margin-bottom: 8px; }
  .plan-title { font-size: 28px; font-weight: 700; color: var(--ink); margin-bottom: 4px; }
  .plan-sub { font-size: 13px; color: var(--ink-light); }
  .plan-meta { display: flex; gap: 24px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); flex-wrap: wrap; }
  .meta-item { font-size: 12px; color: var(--ink-light); }
  .meta-item strong { color: var(--ink); display: block; font-size: 13px; margin-bottom: 2px; }

  /* Already reviewed banner */
  .reviewed-banner { border-radius: 10px; padding: 20px 24px; margin-bottom: 24px; display: none; align-items: center; gap: 14px; }
  .reviewed-banner.approved { background: var(--success-light); border: 1px solid var(--success); }
  .reviewed-banner.revisions { background: var(--warn-light); border: 1px solid var(--warn); }
  .reviewed-banner.denied { background: var(--danger-light); border: 1px solid var(--danger); }
  .reviewed-banner-icon { font-size: 28px; }
  .reviewed-banner-text strong { font-size: 15px; font-weight: 700; display: block; margin-bottom: 2px; }
  .reviewed-banner-text span { font-size: 13px; color: var(--ink-light); }

  /* Plan sections */
  .plan-section { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 28px 36px; margin-bottom: 16px; scroll-margin-top: 90px; }
  .section-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
  .section-label { font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--accent); margin-bottom: 3px; }
  .section-name { font-size: 18px; font-weight: 700; color: var(--ink); }
  .comment-toggle { font-size: 12px; font-weight: 500; color: var(--accent); background: var(--accent-light); border: 1px solid var(--accent); border-radius: 6px; padding: 5px 12px; cursor: pointer; transition: all 0.12s; white-space: nowrap; font-family: 'DM Sans', sans-serif; }
  .comment-toggle:hover { background: var(--accent); color: white; }
  .comment-toggle.has-comment { background: var(--accent); color: white; }
  .section-comment-box { display: none; margin-top: 16px; padding: 16px; background: var(--accent-light); border: 1px solid var(--accent); border-radius: 8px; animation: fadeIn 0.2s ease; }
  .section-comment-box.open { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
  .section-comment-box label { font-size: 11px; font-weight: 600; color: var(--accent); letter-spacing: 0.3px; margin-bottom: 6px; display: block; }
  .section-comment-box textarea { width: 100%; padding: 10px 12px; font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--ink); background: var(--white); border: 1px solid var(--border); border-radius: 6px; outline: none; resize: vertical; min-height: 80px; line-height: 1.6; }
  .section-comment-box textarea:focus { border-color: var(--accent); }

  /* Data display */
  .field-pair { margin-bottom: 14px; }
  .field-label { font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--ink-light); margin-bottom: 3px; }
  .field-value { font-size: 14px; color: var(--ink); line-height: 1.6; }
  .field-value.empty { color: var(--ink-light); font-style: italic; }
  .field-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 14px; }
  .tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
  .tag { background: var(--accent); color: white; border-radius: 4px; padding: 3px 10px; font-size: 12px; font-weight: 500; }

  /* Tables */
  .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .data-table th { font-size: 10px; font-weight: 600; letter-spacing: 0.8px; text-transform: uppercase; color: var(--ink-light); padding: 0 12px 10px 0; text-align: left; border-bottom: 1px solid var(--border); }
  .data-table td { padding: 10px 12px 10px 0; color: var(--ink); border-bottom: 1px solid var(--border); vertical-align: top; line-height: 1.5; }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table tr:hover td { background: var(--cream); }
  .status-pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .pill-complete { background: var(--success-light); color: var(--success); }
  .pill-progress { background: var(--warn-light); color: var(--warn); }
  .pill-blocked { background: var(--danger-light); color: var(--danger); }
  .pill-default { background: var(--cream); color: var(--ink-light); }

  /* Phase headers */
  .phase-header { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; color: var(--ink); margin: 20px 0 10px; }
  .phase-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

  /* Attachments */
  .attachment-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--cream); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
  .attachment-icon { font-size: 18px; }
  .attachment-name { flex: 1; font-weight: 500; }
  .attachment-type { font-size: 11px; color: var(--ink-light); }
  .attachment-link { font-size: 12px; color: var(--accent); text-decoration: none; font-weight: 500; }
  .attachment-link:hover { text-decoration: underline; }

  /* Activity log */
  .activity-log { margin-top: 8px; }
  .log-entry { display: flex; gap: 14px; padding: 12px 0; border-bottom: 1px solid var(--border); }
  .log-entry:last-child { border-bottom: none; }
  .log-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); flex-shrink: 0; margin-top: 6px; }
  .log-body { flex: 1; }
  .log-action { font-size: 13px; font-weight: 600; color: var(--ink); }
  .log-meta { font-size: 12px; color: var(--ink-light); margin-top: 2px; }
  .log-comment { font-size: 13px; color: var(--ink); margin-top: 6px; padding: 8px 12px; background: var(--cream); border-radius: 6px; line-height: 1.5; }
  .log-decision-approved { color: var(--success); }
  .log-decision-revisions { color: var(--warn); }
  .log-decision-denied { color: var(--danger); }

  /* Review panel */
  .review-panel { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 32px 36px; margin-top: 24px; }
  .review-panel-title { font-size: 16px; font-weight: 700; color: var(--ink); margin-bottom: 6px; }
  .review-panel-sub { font-size: 13px; color: var(--ink-light); margin-bottom: 20px; }
  .name-field { margin-bottom: 20px; }
  .name-field label { font-size: 12px; font-weight: 600; color: var(--ink); display: block; margin-bottom: 6px; }
  .name-field input { width: 100%; padding: 10px 14px; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--ink); background: var(--cream); border: 1px solid var(--border); border-radius: 8px; outline: none; transition: border-color 0.15s; }
  .name-field input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(31,65,127,0.1); background: var(--white); }
  .decision-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
  .decision-btn { flex: 1; min-width: 120px; padding: 14px 16px; border-radius: 10px; border: 2px solid var(--border); background: var(--white); font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s; text-align: center; color: var(--ink-light); }
  .decision-btn:hover { border-color: var(--ink-light); color: var(--ink); }
  .decision-btn.selected-approve { border-color: var(--success); background: var(--success-light); color: var(--success); }
  .decision-btn.selected-revisions { border-color: var(--warn); background: var(--warn-light); color: var(--warn); }
  .decision-btn.selected-deny { border-color: var(--danger); background: var(--danger-light); color: var(--danger); }
  .decision-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .overall-comment { margin-bottom: 20px; }
  .overall-comment label { font-size: 12px; font-weight: 600; color: var(--ink); display: block; margin-bottom: 6px; }
  .overall-comment textarea { width: 100%; padding: 12px 14px; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--ink); background: var(--cream); border: 1px solid var(--border); border-radius: 8px; outline: none; resize: vertical; min-height: 100px; line-height: 1.6; transition: border-color 0.15s; }
  .overall-comment textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(31,65,127,0.1); background: var(--white); }
  .submit-review-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
  .submit-review-btn:hover { background: #17336a; }
  .submit-review-btn:disabled { background: var(--border); color: var(--ink-light); cursor: not-allowed; }

  /* Divider */
  .divider { height: 1px; background: var(--border); margin: 20px 0; }

  /* Success */
  .success-screen { display: none; text-align: center; padding: 80px 40px; }
  .success-icon { font-size: 52px; margin-bottom: 16px; }
  .success-title { font-size: 28px; font-weight: 700; color: var(--ink); margin-bottom: 10px; }
  .success-sub { font-size: 14px; color: var(--ink-light); line-height: 1.7; max-width: 400px; margin: 0 auto; }

  @media (max-width: 860px) {
    .sidebar { display: none; }
    .main { padding: 24px; }
    .field-row-3 { grid-template-columns: 1fr; }
    .header { padding: 12px 20px; }
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="assets/RTC_Club_Ride_LG_WHT.png" alt="Club Ride" class="header-logo">
    <div class="header-divider"></div>
    <div class="header-badge">Communications Plan Review</div>
  </div>
  <div class="header-right">
    <button class="docx-btn" id="docx-btn" onclick="exportDocx()">‚Üì Download Word Doc</button>
    <div id="header-status"></div>
  </div>
</header>

<div class="layout" id="main-layout" style="display:none">
  <nav class="sidebar">
    <div class="sidebar-label">Sections</div>
    <a class="toc-item" onclick="scrollToSection('s-overview')">Overview</a>
    <a class="toc-item" onclick="scrollToSection('s-details')">Event Details</a>
    <a class="toc-item" onclick="scrollToSection('s-roles')">Roles & Responsibilities</a>
    <a class="toc-item" onclick="scrollToSection('s-objectives')">Objectives</a>
    <a class="toc-item" onclick="scrollToSection('s-goals')">Goals</a>
    <a class="toc-item" onclick="scrollToSection('s-audience')">Target Audience</a>
    <a class="toc-item" onclick="scrollToSection('s-strategy')">Marketing Strategy</a>
    <a class="toc-item" onclick="scrollToSection('s-tactics')">Tactics</a>
    <a class="toc-item" onclick="scrollToSection('s-specs')">Creative Specs</a>
    <a class="toc-item" onclick="scrollToSection('s-attachments')">Attachments</a>
    <a class="toc-item" onclick="scrollToSection('s-workback')">Workback Calendar</a>
    <a class="toc-item" onclick="scrollToSection('s-comms')">Comms Calendar</a>
    <a class="toc-item" onclick="scrollToSection('s-log')" style="margin-top:4px">Activity Log</a>
    <a class="toc-item" onclick="scrollToSection('s-review')" style="font-weight:600; color:var(--accent)">‚Üì Your Response</a>
  </nav>

  <main class="main">

    <div class="reviewed-banner" id="reviewed-banner">
      <div class="reviewed-banner-icon" id="reviewed-icon"></div>
      <div class="reviewed-banner-text">
        <strong id="reviewed-title"></strong>
        <span id="reviewed-sub"></span>
      </div>
    </div>

    <div class="plan-header">
      <div class="plan-eyebrow">Communications Plan</div>
      <div class="plan-title" id="plan-title">Loading‚Ä¶</div>
      <div class="plan-sub" id="plan-short-name"></div>
      <div class="plan-meta">
        <div class="meta-item"><strong id="meta-date">‚Äî</strong>Event Date</div>
        <div class="meta-item"><strong id="meta-time">‚Äî</strong>Event Time</div>
        <div class="meta-item"><strong id="meta-location">‚Äî</strong>Location</div>
        <div class="meta-item"><strong id="meta-submitted">‚Äî</strong>Submitted</div>
      </div>
    </div>

    <div id="pdf-content">

    <!-- S1: Overview -->
    <div class="plan-section" id="s-overview">
      <div class="section-title-row">
        <div><div class="section-label">Section 1</div><div class="section-name">Overview</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-overview', this)">+ Add Comment</button>
      </div>
      <div class="field-pair"><div class="field-label">Overview</div><div class="field-value" id="f-overview"></div></div>
      <div class="field-pair"><div class="field-label">Theme / Central Message</div><div class="field-value" id="f-theme"></div></div>
      <div class="section-comment-box" id="c-overview"><label>Comment on Overview</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S2: Event Details -->
    <div class="plan-section" id="s-details">
      <div class="section-title-row">
        <div><div class="section-label">Section 2</div><div class="section-name">Key Event Details</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-details', this)">+ Add Comment</button>
      </div>
      <div class="field-row-3">
        <div class="field-pair"><div class="field-label">Date</div><div class="field-value" id="f-date"></div></div>
        <div class="field-pair"><div class="field-label">Time</div><div class="field-value" id="f-time"></div></div>
        <div class="field-pair"><div class="field-label">Location</div><div class="field-value" id="f-location"></div></div>
      </div>
      <div class="field-pair"><div class="field-label">Notes</div><div class="field-value" id="f-event-notes"></div></div>
      <div class="section-comment-box" id="c-details"><label>Comment on Key Event Details</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S3: Roles -->
    <div class="plan-section" id="s-roles">
      <div class="section-title-row">
        <div><div class="section-label">Section 3</div><div class="section-name">Roles & Responsibilities</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-roles', this)">+ Add Comment</button>
      </div>
      <table class="data-table"><thead><tr><th>Name</th><th>Role</th><th>Team / Org</th><th>Responsibilities</th></tr></thead><tbody id="f-roles"></tbody></table>
      <div class="section-comment-box" id="c-roles"><label>Comment on Roles & Responsibilities</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S4: Objectives -->
    <div class="plan-section" id="s-objectives">
      <div class="section-title-row">
        <div><div class="section-label">Section 4</div><div class="section-name">Objectives</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-objectives', this)">+ Add Comment</button>
      </div>
      <div id="f-objectives"></div>
      <div class="section-comment-box" id="c-objectives"><label>Comment on Objectives</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S5: Goals -->
    <div class="plan-section" id="s-goals">
      <div class="section-title-row">
        <div><div class="section-label">Section 5</div><div class="section-name">Goals</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-goals', this)">+ Add Comment</button>
      </div>
      <table class="data-table"><thead><tr><th>Goal</th><th>Target / Metric</th></tr></thead><tbody id="f-goals"></tbody></table>
      <div class="section-comment-box" id="c-goals"><label>Comment on Goals</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S6: Audience -->
    <div class="plan-section" id="s-audience">
      <div class="section-title-row">
        <div><div class="section-label">Section 6</div><div class="section-name">Target Audience</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-audience', this)">+ Add Comment</button>
      </div>
      <div class="field-pair"><div class="field-label">Segments</div><div class="tag-list" id="f-audience"></div></div>
      <div class="field-pair" style="margin-top:14px"><div class="field-label">Notes</div><div class="field-value" id="f-audience-notes"></div></div>
      <div class="section-comment-box" id="c-audience"><label>Comment on Target Audience</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S7: Strategy -->
    <div class="plan-section" id="s-strategy">
      <div class="section-title-row">
        <div><div class="section-label">Section 7</div><div class="section-name">Marketing Strategy</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-strategy', this)">+ Add Comment</button>
      </div>
      <div class="field-pair"><div class="field-label">Key Messages</div><div id="f-messages"></div></div>
      <div class="field-pair" style="margin-top:14px"><div class="field-label">Strategic Notes</div><div class="field-value" id="f-strategy-notes"></div></div>
      <div class="section-comment-box" id="c-strategy"><label>Comment on Marketing Strategy</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S8: Tactics -->
    <div class="plan-section" id="s-tactics">
      <div class="section-title-row">
        <div><div class="section-label">Section 8</div><div class="section-name">Tactics</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-tactics', this)">+ Add Comment</button>
      </div>
      <div class="field-pair"><div class="field-label">Channels</div><div class="tag-list" id="f-tactics"></div></div>
      <div class="field-pair" style="margin-top:14px"><div class="field-label">Notes</div><div class="field-value" id="f-tactics-notes"></div></div>
      <div class="section-comment-box" id="c-tactics"><label>Comment on Tactics</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S9: Specs -->
    <div class="plan-section" id="s-specs">
      <div class="section-title-row">
        <div><div class="section-label">Section 9</div><div class="section-name">Creative Specs</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-specs', this)">+ Add Comment</button>
      </div>
      <table class="data-table"><thead><tr><th>Asset Type</th><th>Dimensions / Specs</th><th>Format</th></tr></thead><tbody id="f-specs"></tbody></table>
      <div class="section-comment-box" id="c-specs"><label>Comment on Creative Specs</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S10: Attachments -->
    <div class="plan-section" id="s-attachments">
      <div class="section-title-row">
        <div><div class="section-label">Section 10</div><div class="section-name">Attachments</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-attachments', this)">+ Add Comment</button>
      </div>
      <div id="f-attachments"></div>
      <div class="section-comment-box" id="c-attachments"><label>Comment on Attachments</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S11: Workback -->
    <div class="plan-section" id="s-workback">
      <div class="section-title-row">
        <div><div class="section-label">Section 11</div><div class="section-name">Workback Calendar</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-workback', this)">+ Add Comment</button>
      </div>
      <div class="phase-header"><div class="phase-dot" style="background:#1F417F"></div>Phase 1 ‚Äî Approval</div>
      <table class="data-table"><thead><tr><th>Task</th><th>Deadline</th><th>Owner</th><th>Status</th></tr></thead><tbody id="f-workback-approval"></tbody></table>
      <div class="phase-header" style="margin-top:20px"><div class="phase-dot" style="background:#8DAA43"></div>Phase 2 ‚Äî Execution</div>
      <table class="data-table"><thead><tr><th>Task</th><th>Deadline</th><th>Owner</th><th>Status</th></tr></thead><tbody id="f-workback-execution"></tbody></table>
      <div class="phase-header" style="margin-top:20px"><div class="phase-dot" style="background:#5A5A56"></div>Phase 3 ‚Äî Post-Event</div>
      <table class="data-table"><thead><tr><th>Task</th><th>Deadline</th><th>Owner</th><th>Status</th></tr></thead><tbody id="f-workback-postevent"></tbody></table>
      <div class="section-comment-box" id="c-workback"><label>Comment on Workback Calendar</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    <!-- S12: Comms Calendar -->
    <div class="plan-section" id="s-comms">
      <div class="section-title-row">
        <div><div class="section-label">Section 12</div><div class="section-name">Communications Calendar</div></div>
        <button class="comment-toggle" onclick="toggleComment('c-comms', this)">+ Add Comment</button>
      </div>
      <table class="data-table"><thead><tr><th>Publish Date</th><th>Channel</th><th>Content Detail</th><th>Owner</th></tr></thead><tbody id="f-comms"></tbody></table>
      <div class="section-comment-box" id="c-comms"><label>Comment on Comms Calendar</label><textarea placeholder="Leave a comment‚Ä¶"></textarea></div>
    </div>

    </div><!-- /pdf-content -->

    <!-- Activity Log -->
    <div class="plan-section" id="s-log">
      <div class="section-title-row" style="border-bottom:none; margin-bottom:0; padding-bottom:0">
        <div><div class="section-label">History</div><div class="section-name">Activity Log</div></div>
      </div>
      <div class="activity-log" id="activity-log">
        <div style="color:var(--ink-light);font-size:13px;font-style:italic;padding:16px 0">No activity yet.</div>
      </div>
    </div>

    <!-- Review Panel -->
    <div class="review-panel" id="s-review">
      <div class="review-panel-title">Your Response</div>
      <div class="review-panel-sub">Select a decision and optionally leave comments before submitting. You can also add comments on individual sections above.</div>

      <div class="name-field">
        <label>Your Name</label>
        <input type="text" id="reviewer-name" placeholder="e.g. Sue Johnson">
      </div>

      <div class="decision-buttons">
        <button class="decision-btn" id="btn-approve" onclick="selectDecision('approved')">‚úì Approve</button>
        <button class="decision-btn" id="btn-revisions" onclick="selectDecision('revisions')">‚Ü© Request Revisions</button>
        <button class="decision-btn" id="btn-deny" onclick="selectDecision('denied')">‚úï Deny</button>
      </div>

      <div class="overall-comment">
        <label>Overall Comments <span style="font-weight:400;color:var(--ink-light)">(optional)</span></label>
        <textarea id="overall-comment" placeholder="Any overall feedback or context for the Club Ride team‚Ä¶"></textarea>
      </div>

      <button class="submit-review-btn" id="submit-review-btn" onclick="submitReview()">Submit Response</button>
    </div>

    <div class="success-screen" id="success-screen">
      <div class="success-icon" id="success-icon"></div>
      <div class="success-title" id="success-title"></div>
      <div class="success-sub" id="success-sub"></div>
    </div>

  </main>
</div>

<div class="loading" id="loading-state"><div class="spinner"></div><span>Loading communications plan‚Ä¶</span></div>
<div class="error-state" id="error-state">
  <div class="error-icon">üîç</div>
  <div class="error-title">Plan not found</div>
  <div class="error-sub">This review link may be invalid or expired. Please contact the Club Ride team for a new link.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL  = 'https://bcvwfthrqfzmfwzauhrl.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjdndmdGhycWZ6bWZ3emF1aHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDE2MDMsImV4cCI6MjA4NzExNzYwM30.kC0SQw_6fev9V-KgJfuYaUdHrrlDUc7CLRfEPXig0eo';
  const RESEND_API    = 're_g3Y49yJv_75gpukCVBWpcKfB6WBTo4TbH';
  const NOTIFY_EMAIL  = 'picazos@rtcsnv.com';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  let submissionId = null;
  let submissionData = null;
  let selectedDecision = null;

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function init() {
    const params = new URLSearchParams(window.location.search);
    submissionId = params.get('review');
    if (!submissionId) { showError(); return; }
    try {
      const { data, error } = await sb.from('submissions').select('*').eq('id', submissionId).single();
      if (error || !data) { showError(); return; }
      submissionData = data;
      renderPlan(data);
      renderActivityLog(data.activity_log || []);
      showReviewed(data);
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('main-layout').style.display = 'flex';
      document.getElementById('docx-btn').style.display = 'flex';
    } catch(e) { console.error(e); showError(); }
  }

  function showError() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'flex';
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function val(v, fallback='‚Äî') { return (v && v.toString().trim()) ? v : `<span class="empty">${fallback}</span>`; }
  function formatDate(str) {
    if (!str) return '';
    const d = new Date(str + (str.length===10?'T12:00:00':''));
    return d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  }
  function formatTime(str) {
    if (!str) return '';
    const [h,m] = str.split(':'); const hr = parseInt(h);
    return `${hr>12?hr-12:hr||12}:${m} ${hr>=12?'PM':'AM'}`;
  }

  // ‚îÄ‚îÄ Render plan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderPlan(data) {
    const fd = data.form_data || {};
    const ov = fd.overview||{}, ev = fd.event_details||{}, ma = fd.marketing_strategy||{}, ta = fd.target_audience||{}, tc = fd.tactics||{};

    document.getElementById('plan-title').textContent = ov.event_name || 'Untitled Plan';
    document.getElementById('plan-short-name').textContent = ov.short_name ? `Short name: ${ov.short_name}` : '';
    document.title = `Review ‚Äî ${ov.event_name || 'Communications Plan'}`;
    document.getElementById('meta-date').innerHTML = val(ev.date ? formatDate(ev.date) : '');
    const time = [ev.start_time, ev.end_time].filter(Boolean).map(formatTime).join(' ‚Äì ');
    document.getElementById('meta-time').innerHTML = val(time);
    document.getElementById('meta-location').innerHTML = val(ev.location);
    document.getElementById('meta-submitted').innerHTML = val(formatDate(data.created_at?.split('T')[0]));

    const statusMap = { pending:['status-pending','Awaiting Review'], draft:['status-pending','Draft'], approved:['status-approved','Approved'], revisions:['status-revisions','Revisions Requested'], denied:['status-denied','Denied'] };
    const [cls, label] = statusMap[data.status] || statusMap.pending;
    document.getElementById('header-status').innerHTML = `<span class="status-badge ${cls}">${label}</span>`;

    document.getElementById('f-overview').innerHTML = val(ov.overview);
    document.getElementById('f-theme').innerHTML = val(ov.theme);
    document.getElementById('f-date').innerHTML = val(ev.date?formatDate(ev.date):'');
    document.getElementById('f-time').innerHTML = val(time);
    document.getElementById('f-location').innerHTML = val(ev.location);
    document.getElementById('f-event-notes').innerHTML = val(ev.notes);

    // Roles
    const rt = document.getElementById('f-roles');
    (fd.roles||[]).forEach(r => { if(r.some(c=>c)) rt.insertAdjacentHTML('beforeend',`<tr>${r.map(c=>`<td>${val(c)}</td>`).join('')}</tr>`); });
    if(!rt.children.length) rt.innerHTML='<tr><td colspan="4" style="color:var(--ink-light);font-style:italic">No roles listed</td></tr>';

    // Objectives
    const obj = document.getElementById('f-objectives');
    (fd.objectives||[]).forEach((o,i)=>{ if(o) obj.insertAdjacentHTML('beforeend',`<div style="display:flex;gap:10px;margin-bottom:8px;font-size:14px;line-height:1.5"><span style="color:var(--accent);font-weight:600;flex-shrink:0">${i+1}.</span><span>${o}</span></div>`); });
    if(!obj.children.length) obj.innerHTML='<span class="field-value empty">No objectives listed</span>';

    // Goals
    const gt = document.getElementById('f-goals');
    (fd.goals||[]).forEach(r=>{ if(r.some(c=>c)) gt.insertAdjacentHTML('beforeend',`<tr>${r.map(c=>`<td>${val(c)}</td>`).join('')}</tr>`); });
    if(!gt.children.length) gt.innerHTML='<tr><td colspan="2" style="color:var(--ink-light);font-style:italic">No goals listed</td></tr>';

    // Audience
    const aud = document.getElementById('f-audience');
    (ta.segments||[]).forEach(s=>aud.insertAdjacentHTML('beforeend',`<span class="tag">${s}</span>`));
    if(!aud.children.length) aud.innerHTML='<span style="color:var(--ink-light);font-style:italic;font-size:13px">None selected</span>';
    document.getElementById('f-audience-notes').innerHTML = val(ta.notes);

    // Strategy
    const msg = document.getElementById('f-messages');
    (ma.key_messages||[]).forEach((m,i)=>{ if(m) msg.insertAdjacentHTML('beforeend',`<div style="display:flex;gap:10px;margin-bottom:10px;padding:12px 14px;background:var(--cream);border-radius:8px;font-size:13px;line-height:1.6"><span style="color:var(--accent);font-weight:700;flex-shrink:0">${i+1}.</span><span>${m}</span></div>`); });
    if(!msg.children.length) msg.innerHTML='<span class="field-value empty">No key messages listed</span>';
    document.getElementById('f-strategy-notes').innerHTML = val(ma.notes);

    // Tactics
    const tac = document.getElementById('f-tactics');
    (tc.channels||[]).forEach(c=>tac.insertAdjacentHTML('beforeend',`<span class="tag">${c}</span>`));
    if(!tac.children.length) tac.innerHTML='<span style="color:var(--ink-light);font-style:italic;font-size:13px">None selected</span>';
    document.getElementById('f-tactics-notes').innerHTML = val(tc.notes);

    // Specs
    const st = document.getElementById('f-specs');
    (fd.creative_specs||[]).forEach(r=>{ if(r.some(c=>c)) st.insertAdjacentHTML('beforeend',`<tr>${r.map(c=>`<td>${val(c)}</td>`).join('')}</tr>`); });
    if(!st.children.length) st.innerHTML='<tr><td colspan="3" style="color:var(--ink-light);font-style:italic">No specs listed</td></tr>';

    // Attachments
    const att = document.getElementById('f-attachments');
    const uploaded = fd.uploaded_files || [];
    const attRows = fd.attachments || [];
    if(!attRows.length && !uploaded.length) { att.innerHTML='<span class="field-value empty">No attachments listed</span>'; }
    else {
      const icons = {Mockup:'üé®',Logo:'‚≠ê',Photography:'üì∑',Video:'üé¨','Copy / Script':'üìù','Flyer / Print':'üóûÔ∏è',Presentation:'üìä',Spreadsheet:'üìã'};
      attRows.forEach((r,i)=>{
        const name=r[0]||'Unnamed', type=r[1]||'', up=uploaded[i];
        att.insertAdjacentHTML('beforeend',`<div class="attachment-item"><span class="attachment-icon">${icons[type]||'üìé'}</span><span class="attachment-name">${name}</span><span class="attachment-type">${type}</span>${up?`<a class="attachment-link" href="${up.url}" target="_blank">View ‚Üó</a>`:''}</div>`);
      });
    }

    // Workback
    const wb = fd.workback||{};
    renderWorkbackPhase('f-workback-approval', wb.approval||[]);
    renderWorkbackPhase('f-workback-execution', wb.execution||[]);
    renderWorkbackPhase('f-workback-postevent', wb.post_event||[]);

    // Comms
    const ct = document.getElementById('f-comms');
    (fd.comms_calendar||[]).forEach(r=>{ if(r.some(c=>c)) ct.insertAdjacentHTML('beforeend',`<tr><td>${r[0]?formatDate(r[0]):'‚Äî'}</td><td>${val(r[1])}</td><td>${val(r[2])}</td><td>${val(r[3])}</td></tr>`); });
    if(!ct.children.length) ct.innerHTML='<tr><td colspan="4" style="color:var(--ink-light);font-style:italic">No items listed</td></tr>';
  }

  function renderWorkbackPhase(tbodyId, rows) {
    const tbody = document.getElementById(tbodyId);
    rows.forEach(r=>{
      if(r.some(c=>c)){
        const pillMap={Complete:'pill-complete','In Progress':'pill-progress',Blocked:'pill-blocked'};
        tbody.insertAdjacentHTML('beforeend',`<tr><td>${val(r[0])}</td><td>${r[1]?formatDate(r[1]):'‚Äî'}</td><td>${val(r[2])}</td><td><span class="status-pill ${pillMap[r[3]]||'pill-default'}">${r[3]||'‚Äî'}</span></td></tr>`);
      }
    });
    if(!tbody.children.length) tbody.innerHTML='<tr><td colspan="4" style="color:var(--ink-light);font-style:italic;font-size:13px;padding:10px 0">No tasks listed</td></tr>';
  }

  // ‚îÄ‚îÄ Activity log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderActivityLog(log) {
    const el = document.getElementById('activity-log');
    if (!log || !log.length) return;
    el.innerHTML = '';
    log.forEach(entry => {
      const decisionClass = entry.decision ? `log-decision-${entry.decision}` : '';
      const decisionLabel = { approved:'‚úì Approved', revisions:'‚Ü© Revisions Requested', denied:'‚úï Denied' }[entry.decision] || '';
      el.insertAdjacentHTML('beforeend', `
        <div class="log-entry">
          <div class="log-dot"></div>
          <div class="log-body">
            <div class="log-action ${decisionClass}">${entry.action}${decisionLabel ? ` ‚Äî <strong>${decisionLabel}</strong>` : ''}</div>
            <div class="log-meta">${entry.reviewer_name ? `<strong>${entry.reviewer_name}</strong> ¬∑ ` : ''}${formatDate(entry.timestamp?.split('T')[0])} at ${formatTimestamp(entry.timestamp)}</div>
            ${entry.overall_comment ? `<div class="log-comment">${entry.overall_comment}</div>` : ''}
            ${entry.section_comments && Object.keys(entry.section_comments).length ? Object.entries(entry.section_comments).map(([k,v])=>`<div class="log-comment"><strong style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--ink-light)">${k}</strong><br>${v}</div>`).join('') : ''}
          </div>
        </div>`);
    });
  }

  function formatTimestamp(ts) {
    if (!ts) return '';
    return new Date(ts).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
  }

  // ‚îÄ‚îÄ Already reviewed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showReviewed(data) {
    if (!['approved','revisions','denied'].includes(data.status)) return;
    const banner = document.getElementById('reviewed-banner');
    const map = { approved:{cls:'approved',icon:'‚úÖ',title:'This plan has been approved.',sub:'Your approval has been recorded.'}, revisions:{cls:'revisions',icon:'‚Ü©Ô∏è',title:'Revisions were requested.',sub:'Your revision request has been recorded.'}, denied:{cls:'denied',icon:'‚ùå',title:'This plan was denied.',sub:'Your denial has been recorded.'} };
    const m = map[data.status];
    banner.className = `reviewed-banner ${m.cls}`;
    document.getElementById('reviewed-icon').textContent = m.icon;
    document.getElementById('reviewed-title').textContent = m.title;
    document.getElementById('reviewed-sub').textContent = m.sub;
    banner.style.display = 'flex';
    document.getElementById('submit-review-btn').disabled = true;
    document.getElementById('submit-review-btn').textContent = 'Response already submitted';
    document.querySelectorAll('.decision-btn').forEach(b => b.disabled = true);
    document.getElementById('overall-comment').disabled = true;
    document.getElementById('reviewer-name').disabled = true;
  }

  // ‚îÄ‚îÄ Decision ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function selectDecision(d) {
    selectedDecision = d;
    document.getElementById('btn-approve').className = 'decision-btn' + (d==='approved'?' selected-approve':'');
    document.getElementById('btn-revisions').className = 'decision-btn' + (d==='revisions'?' selected-revisions':'');
    document.getElementById('btn-deny').className = 'decision-btn' + (d==='denied'?' selected-deny':'');
  }

  // ‚îÄ‚îÄ Section comments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleComment(id, btn) {
    const box = document.getElementById(id);
    box.classList.toggle('open');
    const isOpen = box.classList.contains('open');
    btn.textContent = isOpen ? '‚àí Remove Comment' : '+ Add Comment';
    btn.classList.toggle('has-comment', isOpen);
    if (isOpen) box.querySelector('textarea').focus();
  }

  function collectSectionComments() {
    const sections = ['overview','details','roles','objectives','goals','audience','strategy','tactics','specs','attachments','workback','comms'];
    const comments = {};
    const names = { overview:'Overview', details:'Key Event Details', roles:'Roles & Responsibilities', objectives:'Objectives', goals:'Goals', audience:'Target Audience', strategy:'Marketing Strategy', tactics:'Tactics', specs:'Creative Specs', attachments:'Attachments', workback:'Workback Calendar', comms:'Comms Calendar' };
    sections.forEach(s => {
      const box = document.getElementById(`c-${s}`);
      if (box && box.classList.contains('open')) {
        const v = box.querySelector('textarea').value.trim();
        if (v) comments[names[s]] = v;
      }
    });
    return comments;
  }

  // ‚îÄ‚îÄ Submit review ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function submitReview() {
    if (!selectedDecision) { alert('Please select a decision before submitting.'); return; }
    const btn = document.getElementById('submit-review-btn');
    btn.textContent = 'Submitting‚Ä¶'; btn.disabled = true;

    const reviewerName = document.getElementById('reviewer-name').value.trim();
    const overallComment = document.getElementById('overall-comment').value.trim();
    const sectionComments = collectSectionComments();

    const newLogEntry = {
      action: 'Review submitted',
      decision: selectedDecision,
      reviewer_name: reviewerName || 'Anonymous',
      overall_comment: overallComment,
      section_comments: sectionComments,
      timestamp: new Date().toISOString(),
    };

    const existingLog = submissionData.activity_log || [];
    const updatedLog = [...existingLog, newLogEntry];

    try {
      const { error } = await sb.from('submissions').update({
        status: selectedDecision,
        reviewer_name: reviewerName,
        activity_log: updatedLog,
        review_data: { decision: selectedDecision, overall_comment: overallComment, section_comments: sectionComments, reviewer_name: reviewerName, reviewed_at: new Date().toISOString() },
      }).eq('id', submissionId);
      if (error) throw error;

      await sendNotificationEmail(selectedDecision, reviewerName, overallComment, sectionComments);
      showSuccess(selectedDecision);
    } catch(e) {
      console.error(e);
      alert('Something went wrong. Please try again.\n\n' + (e.message||e));
      btn.textContent = 'Submit Response'; btn.disabled = false;
    }
  }

  // ‚îÄ‚îÄ Email notification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function sendNotificationEmail(decision, reviewerName, overallComment, sectionComments) {
    const decisionLabels = { approved:'‚úÖ Approved', revisions:'‚Ü© Revisions Requested', denied:'‚ùå Denied' };
    const decisionLabel = decisionLabels[decision] || decision;
    const planName = submissionData?.event_name || 'Communications Plan';
    const reviewUrl = window.location.href;
    const resubmitUrl = `${window.location.origin}/portal/index.html?resubmit=${submissionId}`;

    let sectionHtml = '';
    Object.entries(sectionComments).forEach(([k,v]) => {
      sectionHtml += `<div style="margin-bottom:10px;padding:10px 14px;background:#f5f5f3;border-left:3px solid #1F417F;border-radius:0 6px 6px 0"><div style="font-size:11px;font-weight:600;text-transform:uppercase;color:#5A5A56;margin-bottom:3px">${k}</div><div style="font-size:13px;color:#1A1A18;line-height:1.6">${v}</div></div>`;
    });

    const resubmitSection = decision === 'revisions' ? `<div style="margin-top:20px;padding:16px;background:#FDF4E3;border:1px solid #C8860A;border-radius:8px"><div style="font-size:13px;font-weight:600;color:#7a5000;margin-bottom:8px">Revisions requested ‚Äî next step:</div><a href="${resubmitUrl}" style="display:inline-block;background:#1F417F;color:#ffffff;padding:10px 20px;border-radius:6px;text-decoration:none;font-weight:600;font-size:13px">Open Plan to Revise ‚Üí</a></div>` : '';

    const html = `<div style="font-family:'DM Sans',sans-serif;max-width:600px;margin:0 auto;background:#ffffff">
      <div style="background:#1A1A18;padding:20px 28px;border-radius:10px 10px 0 0">
        <span style="font-size:18px;font-weight:700;color:#ffffff">Club<span style="color:#8DAA43">Ride</span></span>
        <span style="margin-left:12px;font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.8px">Plan Review Update</span>
      </div>
      <div style="padding:28px;border:1px solid #E0DAD0;border-top:none;border-radius:0 0 10px 10px">
        <div style="font-size:20px;font-weight:700;color:#1A1A18;margin-bottom:6px">${decisionLabel}</div>
        <div style="font-size:13px;color:#5A5A56;margin-bottom:20px">${reviewerName ? `<strong>${reviewerName}</strong> has reviewed the following plan.` : 'A reviewer has responded to the following plan.'}</div>
        <div style="background:#F7F4EF;border-radius:8px;padding:14px 18px;margin-bottom:20px">
          <div style="font-size:11px;font-weight:600;text-transform:uppercase;color:#5A5A56;margin-bottom:3px">Plan</div>
          <div style="font-size:15px;font-weight:600;color:#1A1A18">${planName}</div>
        </div>
        ${overallComment ? `<div style="margin-bottom:18px"><div style="font-size:11px;font-weight:600;text-transform:uppercase;color:#5A5A56;margin-bottom:8px">Overall Comment</div><div style="font-size:13px;color:#1A1A18;line-height:1.7;padding:12px 14px;background:#F7F4EF;border-radius:8px">${overallComment}</div></div>` : ''}
        ${sectionHtml ? `<div style="margin-bottom:18px"><div style="font-size:11px;font-weight:600;text-transform:uppercase;color:#5A5A56;margin-bottom:8px">Section Comments</div>${sectionHtml}</div>` : ''}
        ${resubmitSection}
        <div style="margin-top:20px"><a href="${reviewUrl}" style="display:inline-block;background:#1F417F;color:#ffffff;padding:10px 20px;border-radius:6px;text-decoration:none;font-weight:600;font-size:13px">View Full Plan ‚Üí</a></div>
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid #E0DAD0;font-size:11px;color:#5A5A56">Sent automatically by the Club Ride communications plan portal.</div>
      </div>
    </div>`;

    await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${RESEND_API}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ from:'Club Ride Portal <onboarding@resend.dev>', to:[NOTIFY_EMAIL], subject:`[${decisionLabel}] ${planName}${reviewerName?' ‚Äî '+reviewerName:''}`, html }),
    });
  }

  // ‚îÄ‚îÄ Show success ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showSuccess(decision) {
    document.getElementById('s-review').style.display = 'none';
    const map = { approved:{icon:'‚úÖ',title:'Plan Approved',sub:'Your approval has been recorded and the Club Ride team has been notified.'}, revisions:{icon:'‚Ü©Ô∏è',title:'Revisions Requested',sub:'Your feedback has been recorded and the Club Ride team has been notified. They will update the plan and resubmit.'}, denied:{icon:'‚ùå',title:'Plan Denied',sub:'Your response has been recorded and the Club Ride team has been notified.'} };
    const m = map[decision];
    document.getElementById('success-icon').textContent = m.icon;
    document.getElementById('success-title').textContent = m.title;
    document.getElementById('success-sub').textContent = m.sub;
    document.getElementById('success-screen').style.display = 'block';
    const cls = {approved:'status-approved',revisions:'status-revisions',denied:'status-denied'}[decision];
    const label = {approved:'Approved',revisions:'Revisions Requested',denied:'Denied'}[decision];
    document.getElementById('header-status').innerHTML = `<span class="status-badge ${cls}">${label}</span>`;
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  // ‚îÄ‚îÄ Word doc export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function exportDocx() {
    const btn = document.getElementById('docx-btn');
    btn.textContent = 'Generating‚Ä¶'; btn.disabled = true;

    try {
      const fd = submissionData.form_data || {};
      const ov = fd.overview||{}, ev = fd.event_details||{}, ma = fd.marketing_strategy||{}, ta = fd.target_audience||{}, tc = fd.tactics||{};
      const log = submissionData.activity_log || [];
      const planName = submissionData.event_name || 'Communications Plan';
      const shortName = submissionData.short_name || '';
      const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, BorderStyle, HeadingLevel, AlignmentType, Packer, ExternalHyperlink } = docx;

      const bold = (text) => new TextRun({ text: String(text||''), bold: true });
      const normal = (text) => new TextRun({ text: String(text||'') });
      const h1 = (text) => new Paragraph({ text: String(text), heading: HeadingLevel.HEADING_1, spacing: { before: 300, after: 100 } });
      const h2 = (text) => new Paragraph({ text: String(text), heading: HeadingLevel.HEADING_2, spacing: { before: 200, after: 80 } });
      const p = (text) => new Paragraph({ children: [normal(text||'‚Äî')], spacing: { after: 100 } });
      const labeledPara = (label, value) => new Paragraph({ children: [bold(label + ': '), normal(value||'‚Äî')], spacing: { after: 100 } });
      const divider = () => new Paragraph({ text: '', border: { bottom: { style: BorderStyle.SINGLE, size: 6, color: 'E0DAD0' } }, spacing: { before: 100, after: 200 } });

      const makeTable = (headers, rows) => new Table({
        width: { size: 100, type: WidthType.PERCENTAGE },
        rows: [
          new TableRow({
            tableHeader: true,
            children: headers.map(h => new TableCell({
              children: [new Paragraph({ children: [bold(h)], spacing: { after: 60 } })],
              shading: { fill: 'EBF0F8' },
            }))
          }),
          ...rows.filter(r => r.some(c => c)).map(r => new TableRow({
            children: r.map(c => new TableCell({
              children: [new Paragraph({ children: [normal(c||'')], spacing: { after: 60 } })],
            }))
          }))
        ]
      });

      const children = [];

      // Title
      children.push(new Paragraph({ children: [bold(planName)], heading: HeadingLevel.TITLE, spacing: { after: 60 } }));
      if (shortName) children.push(new Paragraph({ children: [normal(`Short name: ${shortName}`)], spacing: { after: 200 } }));

      // Section 1
      children.push(h1('Overview'));
      if (ov.overview) children.push(p(ov.overview));
      if (ov.theme) children.push(labeledPara('Theme', ov.theme));
      children.push(divider());

      // Section 2
      children.push(h1('Key Event Details'));
      children.push(labeledPara('Date', ev.date ? formatDate(ev.date) : ''));
      const time = [ev.start_time, ev.end_time].filter(Boolean).map(formatTime).join(' ‚Äì ');
      if (time) children.push(labeledPara('Time', time));
      if (ev.location) children.push(labeledPara('Location', ev.location));
      if (ev.notes) children.push(labeledPara('Notes', ev.notes));
      children.push(divider());

      // Section 3
      children.push(h1('Roles & Responsibilities'));
      if (fd.roles && fd.roles.some(r=>r.some(c=>c))) {
        children.push(makeTable(['Name','Role / Title','Team / Org','Responsibilities'], fd.roles));
      }
      children.push(divider());

      // Section 4
      children.push(h1('Objectives'));
      (fd.objectives||[]).forEach((o,i) => { if(o) children.push(p(`${i+1}. ${o}`)); });
      children.push(divider());

      // Section 5
      children.push(h1('Goals'));
      if (fd.goals && fd.goals.some(r=>r.some(c=>c))) {
        children.push(makeTable(['Goal Description','Target / Metric'], fd.goals));
      }
      children.push(divider());

      // Section 6
      children.push(h1('Target Audience'));
      if (ta.segments && ta.segments.length) children.push(p(ta.segments.join(', ')));
      if (ta.notes) children.push(labeledPara('Notes', ta.notes));
      children.push(divider());

      // Section 7
      children.push(h1('Marketing Strategy'));
      if (ma.key_messages && ma.key_messages.length) {
        children.push(h2('Key Messages'));
        ma.key_messages.forEach((m,i) => { if(m) children.push(p(`${i+1}. ${m}`)); });
      }
      if (ma.notes) { children.push(h2('Strategic Notes')); children.push(p(ma.notes)); }
      children.push(divider());

      // Section 8
      children.push(h1('Tactics'));
      if (tc.channels && tc.channels.length) children.push(p(tc.channels.join(', ')));
      if (tc.notes) children.push(labeledPara('Notes', tc.notes));
      children.push(divider());

      // Section 9
      children.push(h1('Creative Specs'));
      if (fd.creative_specs && fd.creative_specs.some(r=>r.some(c=>c))) {
        children.push(makeTable(['Asset Type','Dimensions / Specs','Format'], fd.creative_specs));
      }
      children.push(divider());

      // Section 10 ‚Äî Attachments as hyperlinks
      children.push(h1('Attachments'));
      const uploaded = fd.uploaded_files || [];
      const attRows = fd.attachments || [];
      if (!attRows.length) { children.push(p('No attachments listed.')); }
      else {
        attRows.forEach((r,i) => {
          const name = r[0]||'Unnamed', type = r[1]||'', up = uploaded[i];
          if (up && up.url) {
            children.push(new Paragraph({
              children: [
                bold(`${name}${type?' ('+type+')':''}: `),
                new ExternalHyperlink({ link: up.url, children: [new TextRun({ text: 'View file', style: 'Hyperlink' })] })
              ],
              spacing: { after: 100 }
            }));
          } else {
            children.push(p(`${name}${type?' ('+type+')':''}`));
          }
        });
      }
      children.push(divider());

      // Section 11
      children.push(h1('Workback Calendar'));
      const wb = fd.workback||{};
      children.push(h2('Phase 1 ‚Äî Approval'));
      if ((wb.approval||[]).some(r=>r.some(c=>c))) children.push(makeTable(['Task','Deadline','Owner','Status'], (wb.approval||[]).map(r=>[r[0],r[1]?formatDate(r[1]):'',r[2],r[3]])));
      else children.push(p('No tasks listed.'));
      children.push(h2('Phase 2 ‚Äî Execution'));
      if ((wb.execution||[]).some(r=>r.some(c=>c))) children.push(makeTable(['Task','Deadline','Owner','Status'], (wb.execution||[]).map(r=>[r[0],r[1]?formatDate(r[1]):'',r[2],r[3]])));
      else children.push(p('No tasks listed.'));
      children.push(h2('Phase 3 ‚Äî Post-Event'));
      if ((wb.post_event||[]).some(r=>r.some(c=>c))) children.push(makeTable(['Task','Deadline','Owner','Status'], (wb.post_event||[]).map(r=>[r[0],r[1]?formatDate(r[1]):'',r[2],r[3]])));
      else children.push(p('No tasks listed.'));
      children.push(divider());

      // Section 12
      children.push(h1('Communications Calendar'));
      if (fd.comms_calendar && fd.comms_calendar.some(r=>r.some(c=>c))) {
        children.push(makeTable(['Publish Date','Channel','Content Detail','Owner'], (fd.comms_calendar||[]).map(r=>[r[0]?formatDate(r[0]):'',r[1],r[2],r[3]])));
      }
      children.push(divider());

      // Activity Log
      if (log.length) {
        children.push(h1('Activity Log'));
        log.forEach(entry => {
          const decisionLabel = {approved:'Approved',revisions:'Revisions Requested',denied:'Denied'}[entry.decision]||'';
          const actionText = `${entry.action}${decisionLabel?' ‚Äî '+decisionLabel:''}`;
          const metaText = `${entry.reviewer_name||'Unknown'} ¬∑ ${formatDate(entry.timestamp?.split('T')[0])} at ${formatTimestamp(entry.timestamp)}`;
          children.push(new Paragraph({ children: [bold(actionText)], spacing: { before: 120, after: 40 } }));
          children.push(new Paragraph({ children: [new TextRun({ text: metaText, color: '5A5A56', size: 20 })], spacing: { after: 60 } }));
          if (entry.overall_comment) children.push(new Paragraph({ children: [normal(entry.overall_comment)], spacing: { after: 60 }, indent: { left: 360 } }));
          if (entry.section_comments) {
            Object.entries(entry.section_comments).forEach(([k,v]) => {
              children.push(new Paragraph({ children: [bold(k+': '), normal(v)], spacing: { after: 60 }, indent: { left: 360 } }));
            });
          }
        });
      }

      const doc = new Document({ sections: [{ children }] });
      const blob = await Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${shortName || planName.replace(/\s+/g,'_')}_CommsPlan.docx`;
      a.click();
      URL.revokeObjectURL(url);

    } catch(e) {
      console.error('DOCX export error:', e);
      alert('Word doc generation failed. Please try again.');
    }

    btn.textContent = '‚Üì Download Word Doc'; btn.disabled = false;
  }

  // ‚îÄ‚îÄ Scroll ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function scrollToSection(id) { document.getElementById(id)?.scrollIntoView({behavior:'smooth',block:'start'}); }

  init();
</script>
</body>
</html>
